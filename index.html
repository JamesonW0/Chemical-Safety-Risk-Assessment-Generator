<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chemical Safety Data Extractor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .selected { background-color: #d4edda !important; }
    </style>
</head>
<body class="container mt-5">
    <h2 class="mb-4">Chemical Safety Data Extractor</h2>
    <div class="mb-3">
        <label for="chemicalsInput" class="form-label">Enter Chemical Names (comma-separated):</label>
        <input type="text" id="chemicalsInput" class="form-control" placeholder="e.g., ethanol, benzene, acetone">
    </div>
    <button class="btn btn-primary" onclick="searchChemicals()">Search</button>
    
    <div class="mt-4" id="resultsContainer"></div>
    <button class="btn btn-success mt-3" onclick="submitSelection()">Submit Selected</button>
    
    <script>
        let selectedCIDs = new Set();

        function fetchWithUA(url) {
            return fetch(url, {
                headers: {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
                }
            }).then(response => response.json());
        }

        function searchChemicals() {
            const input = document.getElementById("chemicalsInput").value;
            const chemicals = input.split(',').map(c => c.trim()).filter(c => c);
            document.getElementById("resultsContainer").innerHTML = "";
            selectedCIDs.clear();
            
            if (chemicals.length === 0) {
                alert("Please enter at least one chemical name.");
                return;
            }
            
            chemicals.forEach(chemical => {
                fetchWithUA(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${chemical}/cids/JSON`)
                    .then(data => {
                        if (data.IdentifierList && data.IdentifierList.CID) {
                            displayResults(chemical, data.IdentifierList.CID);
                        } else {
                            fetchWithUA(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${chemical}/cids/JSON?name_type=word`)
                                .then(data => {
                                    if (data.IdentifierList && data.IdentifierList.CID) {
                                        displayResults(chemical, data.IdentifierList.CID);
                                    } else {
                                        displayResults(chemical, []);
                                    }
                                })
                                .catch(error => console.error("Error fetching alternative data:", error));
                        }
                    })
                    .catch(error => console.error("Error fetching data:", error));
            });
        }
        
        function displayResults(chemical, cids) {
            const container = document.getElementById("resultsContainer");
            const section = document.createElement("div");
            section.classList.add("mt-3");
            section.innerHTML = `<h5>${chemical}</h5>`;
            
            if (cids.length === 0) {
                section.innerHTML += `<p class="text-danger">No results found.</p>`;
            } else {
                cids.forEach(cid => {
                    fetchWithUA(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/property/MolecularFormula/JSON`)
                        .then(data => {
                            if (data.PropertyTable && data.PropertyTable.Properties.length > 0) {
                                const properties = data.PropertyTable.Properties[0];
                                const molecularFormula = properties.MolecularFormula || "N/A";
                                
                                fetchWithUA(`https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/synonyms/JSON`)
                                    .then(synData => {
                                        const synonyms = synData.InformationList?.Information[0]?.Synonym || [];
                                        const synonym = Array.isArray(synonyms) && synonyms.length > 0 ? synonyms[0] : "N/A";
                                        
                                        const button = document.createElement("button");
                                        button.classList.add("btn", "btn-outline-success", "m-1");
                                        button.innerText = `CID: ${cid}, Formula: ${molecularFormula}, Synonym: ${synonym}`;
                                        button.onclick = () => toggleSelection(button, cid);
                                        section.appendChild(button);
                                    })
                                    .catch(error => {
                                        console.error("Error fetching synonyms:", error);
                                        const button = document.createElement("button");
                                        button.classList.add("btn", "btn-outline-success", "m-1");
                                        button.innerText = `CID: ${cid}, Formula: ${molecularFormula}, Synonym: N/A`;
                                        button.onclick = () => toggleSelection(button, cid);
                                        section.appendChild(button);
                                    });
                            }
                        })
                        .catch(error => console.error("Error fetching properties:", error));
                });
            }
            
            container.appendChild(section);
        }

        function toggleSelection(button, cid) {
            if (selectedCIDs.has(cid)) {
                selectedCIDs.delete(cid);
                button.classList.remove("selected");
            } else {
                selectedCIDs.add(cid);
                button.classList.add("selected");
            }
        }

        function submitSelection() {
            if (selectedCIDs.size === 0) {
                alert("Please select at least one CID before submitting.");
                return;
            }

            fetch('/process_cid', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cids: Array.from(selectedCIDs) })
            })
            .then(response => response.json())
            .then(data => alert("Processing started for selected CIDs."))
            .catch(error => console.error("Error sending CIDs:", error));
        }
    </script>
</body>
</html>
